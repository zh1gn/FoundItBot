"""
–£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏ —Å–æ–æ–±—â–µ–Ω–∏–π
"""
import logging
from datetime import datetime
from typing import Optional
from telegram import Bot
from telegram.error import TelegramError

logger = logging.getLogger(__name__)


class NotificationManager:
    """–ú–µ–Ω–µ–¥–∂–µ—Ä —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
    
    def __init__(self, bot: Bot):
        self.bot = bot
    
    async def send_found_notification(self, owner_id: int, item_info: dict, 
                                     finder_info: dict) -> bool:
        """
        –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–∞—Ö–æ–¥–∫–µ –≤–ª–∞–¥–µ–ª—å—Ü—É
        
        Args:
            owner_id: ID –≤–ª–∞–¥–µ–ª—å—Ü–∞ –≤–µ—â–∏
            item_info: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–µ—â–∏ (name, type, qr_id)
            finder_info: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–∞—à–µ–¥—à–µ–º (id, name)
        
        Returns:
            True –µ—Å–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ
        """
        try:
            from config.config import ITEM_TYPES
            
            emoji = ITEM_TYPES.get(item_info.get('item_type', ''), 'üì¶')
            
            text = f"""
üéâ **–í–ê–®–ê –í–ï–©–¨ –ù–ê–ô–î–ï–ù–ê!**

{emoji} **–í–µ—â—å:** {item_info.get('name', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')}
üë§ **–ù–∞—à—ë–ª:** {finder_info.get('name', '–ê–Ω–æ–Ω–∏–º')}
‚è∞ **–í—Ä–µ–º—è:** {datetime.now().strftime('%H:%M, %d.%m.%Y')}
üÜî **QR-–∫–æ–¥:** `{item_info.get('qr_id', 'N/A')}`

–°–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞—à–µ–¥—à–∏–º –∫–∞–∫ –º–æ–∂–Ω–æ —Å–∫–æ—Ä–µ–µ!

üí° –ù–µ –∑–∞–±—É–¥—å—Ç–µ –ø–æ–±–ª–∞–≥–æ–¥–∞—Ä–∏—Ç—å –∑–∞ —á–µ—Å—Ç–Ω–æ—Å—Ç—å! üôè
"""
            
            from telegram import InlineKeyboardButton, InlineKeyboardMarkup
            
            keyboard = [
                [InlineKeyboardButton("üí¨ –ù–∞–ø–∏—Å–∞—Ç—å –Ω–∞—à–µ–¥—à–µ–º—É", 
                                    url=f"tg://user?id={finder_info.get('id')}")]
            ]
            reply_markup = InlineKeyboardMarkup(keyboard)
            
            await self.bot.send_message(
                chat_id=owner_id,
                text=text,
                parse_mode='Markdown',
                reply_markup=reply_markup
            )
            
            logger.info(f"–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤–ª–∞–¥–µ–ª—å—Ü—É {owner_id}")
            return True
            
        except TelegramError as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: {e}")
            return False
    
    async def send_welcome_tips(self, user_id: int) -> bool:
        """
        –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–æ–≤–µ—Ç—ã –Ω–æ–≤–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        
        Args:
            user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
        Returns:
            True –µ—Å–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ
        """
        try:
            text = """
üí° **–ü–æ–ª–µ–∑–Ω—ã–µ —Å–æ–≤–µ—Ç—ã –¥–ª—è –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö**

1Ô∏è‚É£ **–ù–∞—á–Ω–∏—Ç–µ —Å —Å–∞–º—ã—Ö –≤–∞–∂–Ω—ã—Ö –≤–µ—â–µ–π**
   –†—é–∫–∑–∞–∫, –∫–ª—é—á–∏, —Ç–µ–ª–µ—Ñ–æ–Ω, –∫—É—Ä—Ç–∫–∞

2Ô∏è‚É£ **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–Ω—è—Ç–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è**
   "–†—é–∫–∑–∞–∫ Nike —á—ë—Ä–Ω—ã–π" –ª—É—á—à–µ —á–µ–º –ø—Ä–æ—Å—Ç–æ "–†—é–∫–∑–∞–∫"

3Ô∏è‚É£ **–ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –ø–µ—á–∞—Ç—å = –¥–æ–ª–≥–æ–≤–µ—á–Ω–æ—Å—Ç—å**
   –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª–∞–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –≤–æ–¥–æ—Å—Ç–æ–π–∫–æ—Å—Ç–∏

4Ô∏è‚É£ **–†–∞–∑–º–µ—â–∞–π—Ç–µ QR –Ω–∞ –≤–∏–¥–Ω–æ–º –º–µ—Å—Ç–µ**
   –ù–æ —Ç–∞–∫, —á—Ç–æ–±—ã –Ω–µ –∏—Å–ø–æ—Ä—Ç–∏—Ç—å –≤–Ω–µ—à–Ω–∏–π –≤–∏–¥ –≤–µ—â–∏

5Ô∏è‚É£ **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É QR –¥–æ –Ω–∞–∫–ª–µ–∏–≤–∞–Ω–∏—è**
   –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ –∏ —É–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç

üí∞ **–ë–æ–Ω—É—Å:** –ü–µ—Ä–≤—ã–µ 5 –≤–µ—â–µ–π - –±–µ—Å–ø–ª–∞—Ç–Ω–æ!
–ü—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤—å—Ç–µ –∏—Ö –≤ –±–æ—Ç–∞ –∏ –Ω–∞—á–Ω–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è.

–£–¥–∞—á–∏! üöÄ
"""
            
            await self.bot.send_message(
                chat_id=user_id,
                text=text,
                parse_mode='Markdown'
            )
            
            return True
            
        except TelegramError as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–≤–µ—Ç–æ–≤: {e}")
            return False
    
    async def send_stats_digest(self, user_id: int, stats: dict) -> bool:
        """
        –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        
        Args:
            user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            stats: –°–ª–æ–≤–∞—Ä—å —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π
        
        Returns:
            True –µ—Å–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ
        """
        try:
            text = f"""
üìä **–í–∞—à–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞**

üì¶ **–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ –≤–µ—â–µ–π:** {stats.get('total_items', 0)}
üîç **–ù–∞–π–¥–µ–Ω–æ –≤–µ—â–µ–π:** {stats.get('found_items', 0)}
ü§ù **–í—ã –Ω–∞—à–ª–∏ —á—É–∂–∏—Ö –≤–µ—â–µ–π:** {stats.get('helped_find', 0)}

{'‚≠ê –í—ã –≤ —Ç–æ–ø-10 —Å–∞–º—ã—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π!' if stats.get('is_top', False) else ''}

üí° **–°–æ–≤–µ—Ç:** {stats.get('tip', '–î–æ–±–∞–≤—å—Ç–µ –±–æ–ª—å—à–µ –≤–µ—â–µ–π –¥–ª—è –ª—É—á—à–µ–π –∑–∞—â–∏—Ç—ã!')}
"""
            
            await self.bot.send_message(
                chat_id=user_id,
                text=text,
                parse_mode='Markdown'
            )
            
            return True
            
        except TelegramError as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {e}")
            return False


def format_time_ago(timestamp: str) -> str:
    """
    –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Ä–µ–º—è –≤ —É–¥–æ–±–æ—á–∏—Ç–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç "X –Ω–∞–∑–∞–¥"
    
    Args:
        timestamp: –°—Ç—Ä–æ–∫–∞ —Å –≤—Ä–µ–º–µ–Ω–µ–º –≤ —Ñ–æ—Ä–º–∞—Ç–µ ISO
    
    Returns:
        –°—Ç—Ä–æ–∫–∞ –≤–∏–¥–∞ "2 —á–∞—Å–∞ –Ω–∞–∑–∞–¥"
    """
    try:
        dt = datetime.fromisoformat(timestamp)
        now = datetime.now()
        diff = now - dt
        
        seconds = diff.total_seconds()
        
        if seconds < 60:
            return "—Ç–æ–ª—å–∫–æ —á—Ç–æ"
        elif seconds < 3600:
            minutes = int(seconds / 60)
            return f"{minutes} {'–º–∏–Ω—É—Ç—É' if minutes == 1 else '–º–∏–Ω—É—Ç'} –Ω–∞–∑–∞–¥"
        elif seconds < 86400:
            hours = int(seconds / 3600)
            return f"{hours} {'—á–∞—Å' if hours == 1 else '—á–∞—Å–æ–≤'} –Ω–∞–∑–∞–¥"
        else:
            days = int(seconds / 86400)
            return f"{days} {'–¥–µ–Ω—å' if days == 1 else '–¥–Ω–µ–π'} –Ω–∞–∑–∞–¥"
    
    except:
        return timestamp[:10]  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–æ—Å—Ç–æ –¥–∞—Ç—É


def generate_qr_url(qr_id: str, bot_username: str) -> str:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å URL –¥–ª—è QR-–∫–æ–¥–∞
    
    Args:
        qr_id: ID QR-–∫–æ–¥–∞
        bot_username: Username –±–æ—Ç–∞
    
    Returns:
        URL –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –≤ QR-–∫–æ–¥
    """
    return f"https://t.me/{bot_username}?start=found_{qr_id}"


def validate_qr_id(qr_id: str) -> tuple[bool, Optional[str]]:
    """
    –í–∞–ª–∏–¥–∞—Ü–∏—è QR ID
    
    Args:
        qr_id: ID –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    
    Returns:
        (is_valid, error_message)
    """
    qr_id = qr_id.upper().strip()
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞
    if not qr_id.startswith('QR'):
        return False, "QR ID –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å 'QR'"
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏–Ω—ã
    if len(qr_id) < 4:
        return False, "QR ID —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π (–º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞)"
    
    if len(qr_id) > 20:
        return False, "QR ID —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π (–º–∞–∫—Å–∏–º—É–º 20 —Å–∏–º–≤–æ–ª–æ–≤)"
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–º–≤–æ–ª–æ–≤
    if not qr_id[2:].isalnum():
        return False, "QR ID –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã –ø–æ—Å–ª–µ 'QR'"
    
    return True, None


def get_achievement_message(milestone: str) -> str:
    """
    –ü–æ–ª—É—á–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏
    
    Args:
        milestone: –¢–∏–ø –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
    
    Returns:
        –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
    """
    achievements = {
        'first_item': """
üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º —Å –ø–µ—Ä–≤–æ–π –≤–µ—â—å—é!

–í—ã —Å–¥–µ–ª–∞–ª–∏ –ø–µ—Ä–≤—ã–π —à–∞–≥ –∫ –∑–∞—â–∏—Ç–µ —Å–≤–æ–∏—Ö –≤–µ—â–µ–π.
–¢–µ–ø–µ—Ä—å –ø—Ä–∏ –Ω–∞—Ö–æ–¥–∫–µ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ!

üí° –°–æ–≤–µ—Ç: –î–æ–±–∞–≤—å—Ç–µ –µ—â—ë 4 –≤–µ—â–∏ —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ "–ó–∞—â–∏—Ç–Ω–∏–∫"
""",
        'five_items': """
‚≠ê –î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ: "–ó–∞—â–∏—Ç–Ω–∏–∫"

–£ –≤–∞—Å —É–∂–µ 5 –∑–∞—â–∏—â—ë–Ω–Ω—ã—Ö –≤–µ—â–µ–π!
–í—ã —Å–µ—Ä—å—ë–∑–Ω–æ –æ—Ç–Ω–æ—Å–∏—Ç–µ—Å—å –∫ —Å–æ—Ö—Ä–∞–Ω–Ω–æ—Å—Ç–∏ —Å–≤–æ–µ–≥–æ –∏–º—É—â–µ—Å—Ç–≤–∞.

üéÅ –ë–æ–Ω—É—Å: –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è —Å–∫–∏–¥–∫–∞ 20% –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–µ 5 —Å—Ç–∏–∫–µ—Ä–æ–≤!
""",
        'ten_items': """
üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ: "–ú–∞—Å—Ç–µ—Ä –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏"

–ù–µ–≤–µ—Ä–æ—è—Ç–Ω–æ! 10 –≤–µ—â–µ–π –ø–æ–¥ –∑–∞—â–∏—Ç–æ–π!
–í—ã –Ω–∞—Å—Ç–æ—è—â–∏–π –ø—Ä–æ—Ñ–∏ –≤ —ç—Ç–æ–º –¥–µ–ª–µ.

üéÅ –ë–æ–Ω—É—Å: –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø—Ä–µ–º–∏—É–º-–¥–∏–∑–∞–π–Ω –¥–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö QR-–∫–æ–¥–æ–≤!
""",
        'first_found': """
üéä –í–∞—à–∞ –ø–µ—Ä–≤–∞—è –Ω–∞—Ö–æ–¥–∫–∞!

–ö—Ç–æ-—Ç–æ –Ω–∞—à—ë–ª –≤–∞—à—É –≤–µ—â—å –∏ —Å–∏—Å—Ç–µ–º–∞ —Å—Ä–∞–±–æ—Ç–∞–ª–∞ –æ—Ç–ª–∏—á–Ω–æ!
–°–ø–∞—Å–∏–±–æ —á—Ç–æ –¥–æ–≤–µ—Ä—è–µ—Ç–µ QR-–ù–∞—Ö–æ–¥–∫–µ.

üí¨ –ù–µ –∑–∞–±—É–¥—å—Ç–µ –Ω–∞–ø–∏—Å–∞—Ç—å –æ—Ç–∑—ã–≤ –æ —Ç–æ–º, –∫–∞–∫ –≤—Å—ë –ø—Ä–æ—à–ª–æ!
""",
        'helper_bronze': """
ü•â –î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ: "–ü–æ–º–æ—â–Ω–∏–∫" (–ë—Ä–æ–Ω–∑–∞)

–í—ã –ø–æ–º–æ–≥–ª–∏ –≤–µ—Ä–Ω—É—Ç—å 3 –≤–µ—â–∏ –∏—Ö –≤–ª–∞–¥–µ–ª—å—Ü–∞–º!
–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à—É —á–µ—Å—Ç–Ω–æ—Å—Ç—å –∏ –Ω–µ—Ä–∞–≤–Ω–æ–¥—É—à–∏–µ.

üåü –í–∞—à —Ä–µ–π—Ç–∏–Ω–≥ —á–µ—Å—Ç–Ω–æ—Å—Ç–∏: –û—Ç–ª–∏—á–Ω—ã–π
""",
        'helper_silver': """
ü•à –î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ: "–ë–ª–∞–≥–æ–¥–µ—Ç–µ–ª—å" (–°–µ—Ä–µ–±—Ä–æ)

–ù–µ–≤–µ—Ä–æ—è—Ç–Ω–æ! –í—ã –≤–µ—Ä–Ω—É–ª–∏ —É–∂–µ 10 –≤–µ—â–µ–π!
–í—ã –¥–µ–ª–∞–µ—Ç–µ –º–∏—Ä –ª—É—á—à–µ —Å–≤–æ–∏–º–∏ –ø–æ—Å—Ç—É–ø–∫–∞–º–∏.

üéÅ –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –±–æ–Ω—É—Å –¥–ª—è –≤–∞—Å!
""",
        'helper_gold': """
ü•á –î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ: "–õ–µ–≥–µ–Ω–¥–∞" (–ó–æ–ª–æ—Ç–æ)

–í–ê–£! 25 –≤–æ–∑–≤—Ä–∞—â—ë–Ω–Ω—ã—Ö –≤–µ—â–µ–π!
–í—ã - –Ω–∞—Å—Ç–æ—è—â–∞—è –ª–µ–≥–µ–Ω–¥–∞ —á–µ—Å—Ç–Ω–æ—Å—Ç–∏.

üèÜ –í—ã –≤–æ—à–ª–∏ –≤ –ó–∞–ª –°–ª–∞–≤—ã QR-–ù–∞—Ö–æ–¥–∫–∏!
"""
    }
    
    return achievements.get(milestone, "üéâ –î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ!")